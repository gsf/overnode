#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var spawn = require('child_process').spawn;
var util = require('util');

var root = '/var/node/';
var logRoot = '/var/log/node/';

var dirs = fs.readdirSync(root);
var children = [];
dirs.forEach(function(dir) {
  var scriptPath = root+dir+'/server.js';
  console.log('Running script at '+scriptPath);
  var child = spawn('node', [scriptPath]);
  child.stdout.on('data', function(data) {
    fs.writeFile(logRoot+dir+'.access.log', data, function(err) {
      if (err) throw err;
    });
  });
  child.stderr.on('data', function(data) {
    fs.writeFile(logRoot+'error.log', data, function(err) {
      if (err) throw err;
    });
  });
  children.push(child)
});

util.log('Overnode running '+children.length+' processes');

process.on('exit', function() {
  children.forEach(function(child) {
    child.kill();
  });
});
